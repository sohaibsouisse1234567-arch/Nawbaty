<script>
const DASHBOARD_GET="https://your-dashboard-link.com/getAppointments";
const DASHBOARD_ADD="https://your-dashboard-link.com/addAppointment";

/* التاريخ والوقت */
let today=new Date();
let currentDate=today.toISOString().split("T")[0];

const infoMessage=document.getElementById("infoMessage");
const currentDateDiv=document.getElementById("currentDate");
const currentTimeDiv=document.getElementById("currentTime");

currentDateDiv.textContent="تاريخ اليوم: "+currentDate;

function updateTime(){
  const now=new Date();
  currentTimeDiv.textContent=
    "الساعة الآن: "+
    now.getHours().toString().padStart(2,"0")+":"+
    now.getMinutes().toString().padStart(2,"0")+":"+
    now.getSeconds().toString().padStart(2,"0");

  const target=new Date();
  target.setHours(18,0,0,0);
  let diff=target-now;

  if(diff>0){
    let h=Math.floor(diff/1000/60/60);
    let m=Math.floor(diff/1000/60%60);
    let s=Math.floor(diff/1000%60);
    infoMessage.textContent=
      "هام: الوقت المتبقي للحجز الجديد: "+
      h+" س "+m+" د "+s+" ث";
  }else{
    infoMessage.textContent="هام: الحجز متاح الآن";
  }
}
setInterval(updateTime,1000);
updateTime();

/* المواعيد */
function generateSlots(start,end){
  let arr=[];
  for(let h=start;h<end;h++){
    for(let m of [0,15,30,45]){
      arr.push(h.toString().padStart(2,"0")+":"+m.toString().padStart(2,"0"));
    }
  }
  return arr;
}

const slots=[...generateSlots(8,12),...generateSlots(13,16)];
let bookings=[]; // سيتم جلبها من Dashboard

/* جلب الحجوزات من Dashboard */
function fetchBookings(){
  fetch(DASHBOARD_GET)
    .then(res=>res.json())
    .then(data=>{
      bookings=data.filter(b=>b.date===currentDate);
      render();
      renderDoctor();
    })
    .catch(err=>console.log("Error fetching bookings:",err));
}

/* إضافة حجز للـ Dashboard */
function addBookingToDashboard(newBooking){
  fetch(DASHBOARD_ADD,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(newBooking)
  })
  .then(res=>res.json())
  .then(data=>{
    console.log("Booking added:",data);
    fetchBookings(); // إعادة جلب البيانات بعد الإضافة
  })
  .catch(err=>console.log("Error adding booking:",err));
}

/* عرض المواعيد */
function render(){
  const c=document.getElementById("slots");
  c.innerHTML="";
  slots.forEach(t=>{
    const b=bookings.find(x=>x.time===t&&x.date===currentDate);
    let d=document.createElement("div");
    d.className="slot";
    if(b){
      d.classList.add("booked");
      d.innerHTML=b.first+" - محجوز <button>إلغاء</button>";
      d.querySelector("button").onclick=()=>{
        let p=prompt("رقم الهاتف");
        if(p===b.phone){
          // هنا يمكن إضافة DELETE للـ Dashboard إذا كان مدعوم
          bookings=bookings.filter(x=>x!==b);
          render();renderDoctor();
        }
      };
    }else{
      d.textContent=t;
      d.onclick=()=>{
        let f=firstName.value,l=lastName.value,p=phone.value;
        if(!f||!l||!p){alert("أكمل البيانات");return}
        const newBooking={time:t,first:f,last:l,phone:p,date:currentDate};
        addBookingToDashboard(newBooking);
        firstName.value=lastName.value=phone.value="";
      };
    }
    c.appendChild(d);
  });
}

/* الطبيب */
const codeInput=document.getElementById("doctorCode");
const doctorSection=document.getElementById("doctorSection");
const doctorTable=document.getElementById("doctorTable");

codeInput.oninput=()=>{
  doctorSection.style.display=codeInput.value==="2026"?"block":"none";
  renderDoctor();
};

function renderDoctor(){
  doctorTable.innerHTML="";
  bookings.filter(b=>b.date===currentDate)
  .sort((a,b)=>a.time.localeCompare(b.time))
  .forEach(b=>{
    doctorTable.innerHTML+=
      `<tr><td>${b.time}</td><td>${b.first}</td><td>${b.last}</td><td>${b.phone}</td></tr>`;
  });
}

/* أول مرة جلب البيانات */
fetchBookings();
</script>
